<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<header th:fragment="header" class="main-header">
    <script th:inline="javascript">
        window.isUserLoggedIn = /*[[${session.user != null}]]*/ false;
        window.userId = /*[[${session.user != null ? session.user.idForAdmin : 'guest'}]]*/ 'guest';
        window.isAdmin = /*[[${session.isAdmin != null ? session.isAdmin : false}]]*/ false;
    </script>
    <!-- 통합된 단일 헤더 -->
    <div class="header-main">
        <div class="header-container">
            <!-- 상단 라인: 로고 + 검색 + 사용자 메뉴 -->
            <div class="header-top-line">
                <!-- 로고 -->
                <div class="logo">
                    <a th:href="@{/main}">
                        <img src="/layout/책크인_이미지.png" alt="책크인 로고">
                    </a>
                </div>
                <!-- 검색창 (상세검색 토글 내장) -->
                <div class="search-container">
                    <form class="search-box" role="search" action="/product/search" method="get">
                        <button type="button" class="detailed-search-toggle" id="detailedSearchToggle" title="상세검색" aria-label="상세검색 옵션 열기">상세검색</button>
                        <label for="searchInput" class="visually-hidden">검색어 입력</label>
                        <input type="text" id="searchInput" name="q" placeholder="검색어를 입력하세요" class="search-input" aria-label="검색어 입력">
                        <button type="submit" class="search-btn" id="searchBtn" aria-label="검색 실행">검색</button>
                    </form>
                    <!-- 상세검색 드롭다운 -->
                    <div class="detailed-search-dropdown" id="detailedSearchDropdown" role="dialog" aria-labelledby="detailedSearchToggle">
                        <form id="advancedSearchForm" action="/product/search-advanced" method="get">
                            <div class="search-field">
                                <label for="bookTitle">제목</label>
                                <input type="text" id="bookTitle" name="bookTitle" placeholder="제목을 입력하세요" />
                            </div>
                            <div class="search-field">
                                <label for="author">저자명</label>
                                <input type="text" id="author" name="author" placeholder="저자명을 입력하세요" />
                            </div>
                            <div class="search-field">
                                <label for="publisher">출판사</label>
                                <input type="text" id="publisher" name="publisher" placeholder="출판사를 입력하세요" />
                            </div>
                            <button type="submit" class="detailed-search-btn" id="advancedSearchBtn">상세검색</button>
                        </form>
                    </div>
                </div>
                <!-- 사용자 메뉴 (우측 정렬) -->
                <nav class="user-menu" aria-label="사용자 메뉴">
                    <!-- 로그인 상태에 따른 메뉴 -->
                    <!-- 관리자 로그인시 메뉴 -->
                    <div th:if="${session.user != null && session.isAdmin}" class="user-logged-in">
                        <a th:href="@{/logout}" class="header-link">로그아웃</a>
                        <a th:href="@{/cart}" class="header-link" id="headerCartLink">장바구니</a>
                        <a th:href="@{/admin/product-inquiry}" class="header-link" id="headerAdminLink">관리자페이지</a>
                    </div>
                    <!-- 일반 사용자 로그인시 메뉴 -->
                    <div th:if="${session.user != null && !session.isAdmin}" class="user-logged-in">
                        <a th:href="@{/logout}" class="header-link">로그아웃</a>
                        <a th:href="@{/cart}" class="header-link" id="headerCartLink">장바구니</a>
                        <a th:href="@{/mypage}" class="header-link" id="headerMypageLink">마이페이지</a>
                    </div>
                    <div th:unless="${session.user}" class="user-not-logged">
                        <a th:href="@{/login}" class="header-link">로그인</a>
                        <a th:href="@{/register}" class="header-link">회원가입</a>
                        <a href="#" class="header-link need-login">장바구니</a>
                        <a href="#" class="header-link need-login">마이페이지</a>
                    </div>
                </nav>
            </div>
            <!-- 하단 라인: 메뉴들 -->
            <div class="header-bottom-line">
                <!-- 햄버거 메뉴 (전체메뉴) -->
                <div class="menu-dropdown">
                    <button class="menu-toggle" id="menuToggle" aria-expanded="false" aria-label="전체 메뉴 열기">
                        <div class="hamburger">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                        <span>전체메뉴</span>
                    </button>
                    <!-- 햄버거 메뉴 드롭다운 - 교보문고 스타일 (DTO 적용) -->
                    <div class="menu-dropdown-content" id="menuDropdown" role="menu">
                        <!-- 닫기 버튼 -->
                        <button class="menu-close-btn" id="menuCloseBtn" aria-label="메뉴 닫기">✕</button>
                        <div class="category-section">
                            <!-- 좌측: 대분류 목록 -->
                            <div class="top-category-list">
                                <h4>카테고리</h4>
                                <!-- 전체 상품 버튼 -->
                                <div class="top-category-item">
                                    <button class="top-category-button all-products-btn" 
                                            onclick="location.href='/product/search-advanced'">
                                        전체 상품
                                    </button>
                                </div>
                                <div th:if="${topCategories != null and !#lists.isEmpty(topCategories)}">
                                    <div th:each="topCategory : ${topCategories}" class="top-category-item">
                                        <button class="top-category-button"
                                                th:data-category-id="${topCategory.topCategory}"
                                                th:text="${topCategory.topCategoryName}">
                                            카테고리명
                                        </button>
                                    </div>
                                </div>
                                <div th:if="${topCategories == null or #lists.isEmpty(topCategories)}"
                                     style="padding: 20px; text-align: center; color: #999;">
                                    카테고리 데이터를 불러올 수 없습니다.
                                </div>
                            </div>
                            <!-- 우측: 중분류/소분류 영역 -->
                            <div class="sub-category-area">
                                <div th:if="${topCategories != null and !#lists.isEmpty(topCategories)}">
                                    <div th:each="topCategory : ${topCategories}"
                                         class="sub-category-content"
                                         th:id="'sub-' + ${topCategory.topCategory}">
                                        <h4 th:text="${topCategory.topCategoryName}">선택된 카테고리</h4>
                                        <!-- 중분류 목록 -->
                                        <div class="middle-category-list">
                                            <div th:each="midCategory : ${middleCategoriesMap[topCategory.topCategory]}"
                                                 class="middle-category-item"
                                                 th:if="${middleCategoriesMap != null and middleCategoriesMap[topCategory.topCategory] != null}">
                                                <button class="middle-category-button"
                                                        th:data-category-id="${midCategory.midCategory}"
                                                        th:data-parent="${topCategory.topCategory}">
                                                    <span th:text="${midCategory.midCategoryName}">중분류명</span>
                                                </button>
                                                <!-- 소분류 목록 -->
                                                <div class="low-category-list"
                                                     th:id="'low-' + ${midCategory.midCategory}"
                                                     th:if="${lowCategoriesMap != null and lowCategoriesMap[midCategory.midCategory] != null and !#lists.isEmpty(lowCategoriesMap[midCategory.midCategory])}">
                                                    <div th:each="lowCategory : ${lowCategoriesMap[midCategory.midCategory]}"
                                                         class="low-category-item"
                                                         th:data-category-id="${lowCategory.lowCategory}"
                                                         th:data-parent="${midCategory.midCategory}"
                                                         th:text="${lowCategory.lowCategoryName}">
                                                        소분류명
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- 기본 메시지 -->
                                <div class="default-message" style="padding: 50px 20px; text-align: center; color: #999;">
                                    좌측에서 카테고리를 선택해주세요
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- 인기검색도서 롤링바 (우측 정렬) -->
                <div class="popular-search-rolling" id="popularSearchRolling">
                    <div class="rolling-container">
                        <span class="rolling-label">인기 검색도서</span>
                        <div class="rolling-text" id="rollingText">
                            <span></span>
                        </div>
                    </div>
                    <!-- 호버시 나타나는 상세 목록 -->
                    <div class="popular-search-detail" id="popularSearchDetail" role="dialog" aria-label="인기검색도서 목록">
                        <h4>인기 검색도서</h4>
                        <ol class="popular-search-list">
                            <!-- JS가 동적으로 <li>를 채움 -->
                        </ol>
                        <div class="keyword-time" id="popular-keyword-time"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- 최근 조회한 책 사이드바 (고정, 크기 축소) -->
    <aside class="recent-books-sidebar" id="recentBooksSidebar" aria-label="최근 조회한 책" style="margin-top: 30px;">
        <div class="recent-books-header">
            <h4>최근 조회</h4>
        </div>
        <div class="recent-books-list" id="recentBooksList" style="max-height:320px; overflow-y:auto; display:flex; flex-direction:column; gap:16px; padding:8px 0;">
            <!-- 최근 조회한 책 목록이 여기에 동적으로 추가됩니다 -->
        </div>
        <!-- 최근 조회 목록 삭제 버튼 추가 -->
        <div class="recent-books-footer">
            <button class="clear-recent-btn" id="clearRecentBtn">목록삭제</button>
        </div>
    </aside>
    <!-- TOP 버튼 -->
    <button class="top-button" id="topButton" aria-label="페이지 상단으로 이동">
        TOP
    </button>
    
    <!-- AI 챗봇 -->
    <div class="chatbot-container">
        <!-- 챗봇 토글 버튼 -->
        <button class="chatbot-toggle" id="chatbotToggle" aria-label="AI 챗봇">
            🤖
        </button>
        
        <!-- 챗봇 창 -->
        <div class="chatbot-window" id="chatbotWindow">
            <div class="chatbot-header">
                <h3>🤖 책크인 AI</h3>
                <button class="chatbot-new-chat" id="chatbotNewChat">🔄리셋</button>
                <button class="chatbot-close" id="chatbotClose" aria-label="챗봇 닫기">✕</button>
            </div>
            
            <div class="chatbot-messages" id="chatbotMessages">
                <div class="bot-message">안녕하세요! 책크인 AI 서비스입니다.<br>어떤 서비스를 찾고 계신가요?
                    <div class="message-suggestions">
                        <button class="suggestion-btn" data-text="한강 정보 알려줘">🕵️ 위키서비스</button>
                        <button class="suggestion-btn" data-text="스트레스 해소할 수 있는 책 추천해줘">😌 힐링 도서</button>
                        <button class="suggestion-btn" data-text="자기계발서 추천해줘">💪 자기계발</button>
                    </div>
                </div>
            </div>
            
            <div class="chatbot-input-area">
                <div class="chatbot-input-container">
                    <input type="text" id="chatbotInput" placeholder="메세지를 입력해주세요." maxlength="200">
                    <button id="chatbotSend" aria-label="메시지 전송">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M2,21L23,12L2,3V10L17,12L2,14V21Z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
</header>

</html>
